FROM php:8.3-fpm

WORKDIR /var/www/html

RUN set -eux; \
    apt-get update; \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    build-essential curl git wget unzip \
    libxml2-dev libpq-dev libpng-dev libjpeg-dev libfreetype6-dev \
    libzip-dev libonig-dev libssl-dev zlib1g-dev libicu-dev \
    libcurl4-openssl-dev \
    postgresql-client nginx ca-certificates supervisor \
    nodejs npm \
    chromium chromium-driver \
    default-jre lsb-release gnupg \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

RUN docker-php-ext-configure gd --with-freetype --with-jpeg && \
    docker-php-ext-install \
    gd pdo pdo_mysql pdo_pgsql mysqli intl zip soap mbstring \
    opcache fileinfo exif curl

RUN pecl install xdebug redis && docker-php-ext-enable xdebug redis

RUN { \
    echo 'max_input_vars = 5000'; \
    echo 'post_max_size = 128M'; \
    echo 'upload_max_filesize = 128M'; \
    echo 'max_execution_time = 300'; \
    echo 'memory_limit = 512M'; \
    } > /usr/local/etc/php/conf.d/moodle.ini

RUN { \
    echo 'xdebug.mode=debug,develop'; \
    echo 'xdebug.start_with_request=yes'; \
    echo 'xdebug.client_host=host.docker.internal'; \
    echo 'xdebug.client_port=9003'; \
    } > /usr/local/etc/php/conf.d/xdebug.ini

RUN { \
    echo 'opcache.enable=0'; \
    echo 'opcache.enable_cli=0'; \
    } > /usr/local/etc/php/conf.d/opcache.ini

RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer && \
    npm install -g grunt-cli webpack

# Install PHPUnit and Behat globally
RUN composer global require phpunit/phpunit:^10.0 && \
    composer global require behat/behat:^3.0 && \
    ln -s /root/.composer/vendor/bin/phpunit /usr/local/bin/phpunit && \
    ln -s /root/.composer/vendor/bin/behat /usr/local/bin/behat

COPY nginx.conf /etc/nginx/nginx.conf
COPY default.conf /etc/nginx/conf.d/default.conf
COPY php-fpm-www.conf /usr/local/etc/php-fpm.d/www.conf
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

RUN mkdir -p /var/log/nginx /var/run/nginx /var/cache/nginx && \
    chown -R www-data:www-data /var/www/html

EXPOSE 80 443 9000 9003

HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost/health.php || exit 1

ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
