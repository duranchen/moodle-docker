server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;
    root /var/www/html;
    index index.php index.html index.htm;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Hide all dot files but allow "Well-Known URIs" as per RFC 5785
    location ~ /\.(?!well-known).* {
        return 404;
    }

    location ~* ^/(?:config\.php|\.git) {
        deny all;
    }

    # Moodle PHP-FPM configuration with slash arguments and routing support
    location ~ \.php(/|$) {
        # Split the path info based on URI.
        fastcgi_split_path_info ^(.+\.php)(/.*)$;

        # Note: Store the original path_info. It will be wiped out in a moment by try_files.
        set $path_info $fastcgi_path_info;

        # Look for the php file. If not round then jump to @routed.
        try_files $fastcgi_script_name $fastcgi_script_name/;

        # File was found - pass to fastcgi.
        fastcgi_pass   php:9000;
        include        fastcgi_params;

        # Re-apply the path_info after including fastcgi_params.
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }

    location = /health.php {
        access_log off;
        fastcgi_pass php:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # Routing engine for Moodle 4.5+
    location / {
        try_files $uri $uri/ /r.php;
    }

    # XSendfile (X-Accel-Redirect) support for Moodle dataroot
    location /dataroot/ {
        internal;
        alias /var/www/moodledata/;
    }

    # Don't allow direct access to various internal files. See MDL-69333
    location ~ (/vendor/|/node_modules/|composer\.json|/readme|/README|readme\.txt|/upgrade\.txt|/UPGRADING\.md|db/install\.xml|/fixtures/|/behat/|phpunit\.xml|\.lock|environment\.xml) {
        deny all;
        return 404;
    }
}
